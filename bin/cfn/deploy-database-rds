#! /usr/bin/env bash
set -e # stop the execution of the script if it fails

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"

CFN_PATH="$ROOT_DIR/aws/cfn/database/database.yaml"

# -------------------------------------------------------------------
# Explicit deploy configuration
# -------------------------------------------------------------------
STACK_NAME="CrdDb"
REGION="eu-west-2"
BUCKET="cfn-artifacts-225442939245-eu-west-2"

# CloudFormation parameters
# must set DB_PASSWORD  in env ,export DB_PASSWORD=********
NETWORKING_STACK="CrdNet"
CLUSTER_STACK="CrdCluster"
MASTER_USERNAME="cruddurroot"
# MASTER_USER_PASSWORD="$DB_PASSWORD"
MASTER_USER_PASSWORD="Super776Secre776tPassword"


PostConfirmationLambdaSecurityGroupId="sg-0054d7dde919ae1ae"
DbConsumerLambdaSecurityGroupId="sg-06c4be906d034d5cc"

echo "Deploying Database Stack"
echo "Template: $CFN_PATH"
echo "Stack:    $STACK_NAME"
echo "Region:   $REGION"
echo "Bucket:   $BUCKET"

aws cloudformation deploy \
  --stack-name "$STACK_NAME" \
  --s3-bucket "$BUCKET" \
  --s3-prefix db \
  --region "$REGION" \
  --template-file "$CFN_PATH" \
  --tags group=cruddur-db \
  --parameter-overrides \
    NetworkingStack="$NETWORKING_STACK" \
    ClusterStack="$CLUSTER_STACK" \
    MasterUsername="$MASTER_USERNAME" \
    MasterUserPassword="$MASTER_USER_PASSWORD" \
    DbConsumerLambdaSecurityGroupId="$DbConsumerLambdaSecurityGroupId" \
    PostConfirmationLambdaSecurityGroupId="$PostConfirmationLambdaSecurityGroupId" \
  --capabilities CAPABILITY_NAMED_IAM
