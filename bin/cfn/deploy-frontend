#! /usr/bin/env bash
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"

CFN_PATH="$ROOT_DIR/aws/cfn/frontend-ecs/frontend-ecs.yaml"

# -------------------------------------------------------------------
# Explicit deploy configuration
# -------------------------------------------------------------------
STACK_NAME="CrdSrvFrontend"
REGION="eu-west-2"
BUCKET="cfn-artifacts-225442939245-eu-west-2"

# Stack dependencies
DNS_STACK="CrdDns"
# Optionally override with HOSTED_ZONE_ID env var if the DNS stack isn't used
HOSTED_ZONE_ID=Z07396163MWBNYQ71OQ9A

# Certificate must be in us-east-1 for CloudFront
CERTIFICATE_ARN="arn:aws:acm:us-east-1:225442939245:certificate/2cbac534-9a60-4476-aed9-4cf5389e3e2f"

# Domain configuration
ROOT_DOMAIN_NAME="cruddur.jawid.me"

echo "Deploying Frontend Stack"
echo "Template: $CFN_PATH"
echo "Stack:    $STACK_NAME"
echo "Region:   $REGION"
echo "Bucket:   $BUCKET"



# Resolve hosted zone ID (prefer explicit env override)
if [[ -z "$HOSTED_ZONE_ID" ]]; then
  HOSTED_ZONE_ID="$(aws cloudformation describe-stacks \
    --stack-name "$DNS_STACK" \
    --query 'Stacks[0].Outputs[?OutputKey==`HostedZoneId`].OutputValue' \
    --output text \
    --region "$REGION" 2>/dev/null || true)"
fi

if [[ -z "$HOSTED_ZONE_ID" || "$HOSTED_ZONE_ID" == "None" ]]; then
  echo "ERROR: HostedZoneId not found. Set HOSTED_ZONE_ID=<zone-id> or deploy the DNS stack ($DNS_STACK)." >&2
  exit 1
fi


# echo "STACK_NAME: $STACK_NAME"
# echo "BUCKET: $BUCKET" 
# echo "REGION: $REGION"
# echo "CFN_PATH: $CFN_PATH"
# echo "CERTIFICATE_ARN: $CERTIFICATE_ARN"
# echo "ROOT_DOMAIN_NAME: $ROOT_DOMAIN_NAME"
# echo "HOSTED_ZONE_ID: $HOSTED_ZONE_ID"

  aws cloudformation deploy \
  --stack-name "$STACK_NAME" \
  --s3-bucket "$BUCKET" \
  --s3-prefix frontend-service \
  --region "$REGION" \
  --template-file "$CFN_PATH" \
  --tags group=cruddur-frontend \
  --parameter-overrides \
    CertificateArn="$CERTIFICATE_ARN" \
    RootDomainName="$ROOT_DOMAIN_NAME" \
    HostedZoneId="$HOSTED_ZONE_ID" \
  --capabilities CAPABILITY_NAMED_IAM

