#! /usr/bin/env bash
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"

CFN_PATH="$ROOT_DIR/aws/cfn/frontend-ecs/frontend-ecs.yaml"

# -------------------------------------------------------------------
# Explicit deploy configuration
# -------------------------------------------------------------------
STACK_NAME="CrdSrvFrontend"
REGION="eu-west-2"
BUCKET="cfn-artifacts-225442939245-eu-west-2"

# Stack dependencies
DNS_STACK="CrdDns"

# Certificate must be in us-east-1 for CloudFront
CERTIFICATE_ARN="arn:aws:acm:us-east-1:225442939245:certificate/2cbac534-9a60-4476-aed9-4cf5389e3e2f"

# Domain configuration
ROOT_DOMAIN_NAME="cruddur.jawid.me"

echo "Deploying Frontend Stack"
echo "Template: $CFN_PATH"
echo "Stack:    $STACK_NAME"
echo "Region:   $REGION"
echo "Bucket:   $BUCKET"



aws cloudformation deploy \
  --stack-name "$STACK_NAME" \
  --s3-bucket "$BUCKET" \
  --s3-prefix frontend-service \
  --region "$REGION" \
  --template-file "$CFN_PATH" \
  --tags group=cruddur-frontend \
  --parameter-overrides \
    CertificateArn="$CERTIFICATE_ARN" \
    RootDomainName="$ROOT_DOMAIN_NAME" \
    HostedZoneId="$(aws cloudformation describe-stacks --stack-name $DNS_STACK --query 'Stacks[0].Outputs[?OutputKey==`HostedZoneId`].OutputValue' --output text --region $REGION)" \
  --capabilities CAPABILITY_NAMED_IAM

