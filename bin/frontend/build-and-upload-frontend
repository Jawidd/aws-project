#!/usr/bin/env bash
set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_ROOT="$(realpath "$SCRIPT_DIR/../../frontend-react-js")"
S3_BUCKET="cruddur.jawid.me"

if [ ! -d "$PROJECT_ROOT" ]; then
  echo "Error: frontend-react-js folder not found at $PROJECT_ROOT"
  exit 1
fi

printf "\033[1;35m == Building and uploading frontend... \033[0m\n"

cd "$PROJECT_ROOT" || exit 1

# Build the Docker image
docker build \
  --build-arg REACT_APP_BACKEND_URL="https://api.cruddur.jawid.me" \
  --build-arg REACT_APP_WEBSOCKET_URL="wss://0q8e5o27ac.execute-api.eu-west-2.amazonaws.com/prod" \
  --build-arg REACT_APP_AWS_REGION="eu-west-2" \
  --build-arg REACT_APP_USER_POOL_ID="eu-west-2_Jwi9THX3b" \
  --build-arg REACT_APP_USER_POOL_CLIENT_ID="1ls5p1vu83m5ahseab36ufk6vm" \
  --build-arg REACT_APP_AVATAR_API_URL="https://e5mz6glfej.execute-api.eu-west-2.amazonaws.com" \
  --build-arg REACT_APP_ASSETS_BASE_URL="https://assets.cruddur.jawid.me" \
  -t frontend-react-js \
  -f Dockerfile.prod \
  .

# Ensure no stale temp container exists
docker rm -f temp-container >/dev/null 2>&1 || true

# Extract build files from FINAL image (nginx path)
docker create --name temp-container frontend-react-js
docker cp temp-container:/usr/share/nginx/html ./build
docker rm temp-container

# Upload to S3
aws s3 sync ./build/ s3://$S3_BUCKET --delete --region eu-west-2

# Clean up
rm -rf ./build

echo "Frontend built and uploaded to S3 successfully."
