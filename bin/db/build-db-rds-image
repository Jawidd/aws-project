#!/usr/bin/env bash
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(realpath "$SCRIPT_DIR/../..")"

IMAGE_NAME="db-rds"
REGION="eu-west-2"
ACCOUNT_ID="225442939245"
ECR_REPO="db-rds"

echo "Ensuring ECR repo $ECR_REPO exists..."

aws ecr describe-repositories \
  --repository-names "$ECR_REPO" \
  --region "$REGION" >/dev/null 2>&1 || \
aws ecr create-repository \
  --repository-name "$ECR_REPO" \
  --region "$REGION"

echo "Logging into ECR..."
aws ecr get-login-password --region "$REGION" \
  | docker login \
    --username AWS \
    --password-stdin "$ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com"

echo "Building db-rds image..."

docker build \
  -t "$ECR_REPO" \
  -f "$PROJECT_ROOT/db/db-rds/Dockerfile" \
  "$PROJECT_ROOT"

echo "Tagging image..."
docker tag "$ECR_REPO:latest" \
  "$ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com/$ECR_REPO:latest"

echo "Pushing image..."
docker push \
  "$ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com/$ECR_REPO:latest"

echo "âœ… db-rds image built and pushed successfully"
