#! /usr/bin/env bash
set -euo pipefail

REGION="eu-west-2"
CLUSTER_STACK="CrdCluster"
SERVICE_STACK="CrdSrvDbShell"
CONTAINER_NAME="db-shell"

cluster_name=$(aws cloudformation describe-stacks \
  --stack-name "$CLUSTER_STACK" \
  --region "$REGION" \
  --query "Stacks[0].Outputs[?OutputKey=='ClusterName'].OutputValue" \
  --output text)

service_name=$(aws cloudformation describe-stacks \
  --stack-name "$SERVICE_STACK" \
  --region "$REGION" \
  --query "Stacks[0].Outputs[?OutputKey=='DbShellServiceName'].OutputValue" \
  --output text)

if [[ -z "$cluster_name" || -z "$service_name" ]]; then
  echo "Cluster or service name could not be resolved. Have you deployed both stacks?"
  exit 1
fi

echo "Scaling db-shell service to 1 task..."
aws ecs update-service \
  --region "$REGION" \
  --cluster "$cluster_name" \
  --service "$service_name" \
  --desired-count 1 \
  >/dev/null

aws ecs wait services-stable \
  --region "$REGION" \
  --cluster "$cluster_name" \
  --services "$service_name"

task_arn=$(aws ecs list-tasks \
  --region "$REGION" \
  --cluster "$cluster_name" \
  --service-name "$service_name" \
  --desired-status RUNNING \
  --query 'taskArns[0]' \
  --output text)

if [[ "$task_arn" == "None" || -z "$task_arn" ]]; then
  echo "No running tasks found for $service_name after scaling."
  exit 1
fi

echo "Opening psql shell via ECS Exec..."
aws ecs execute-command \
  --region "$REGION" \
  --cluster "$cluster_name" \
  --task "$task_arn" \
  --container "$CONTAINER_NAME" \
  --interactive \
  --command "psql \"\$CONNECTION_URL\""

echo "Scaling db-shell service back to 0..."
aws ecs update-service \
  --region "$REGION" \
  --cluster "$cluster_name" \
  --service "$service_name" \
  --desired-count 0 \
  >/dev/null

aws ecs wait services-stable \
  --region "$REGION" \
  --cluster "$cluster_name" \
  --services "$service_name"

echo "Done. db-shell service scaled down."
