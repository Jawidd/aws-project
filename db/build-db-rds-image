#! /usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

REGION="eu-west-2"
ACCOUNT_ID="225442939245"
REPO_NAME="db-rds"
IMAGE_TAG="latest"
IMAGE_URI="${ACCOUNT_ID}.dkr.ecr.${REGION}.amazonaws.com/${REPO_NAME}:${IMAGE_TAG}"

echo "Ensuring ECR repo ${REPO_NAME} exists..."
aws ecr describe-repositories --repository-names "${REPO_NAME}" --region "${REGION}" >/dev/null 2>&1 || \
  aws ecr create-repository --repository-name "${REPO_NAME}" --image-scanning-configuration scanOnPush=true --region "${REGION}"

echo "Logging into ECR..."
aws ecr get-login-password --region "${REGION}" | docker login --username AWS --password-stdin "${ACCOUNT_ID}.dkr.ecr.${REGION}.amazonaws.com"

echo "Building ${REPO_NAME} image..."
docker build -f "$ROOT_DIR/db/db-rds/Dockerfile" -t "${REPO_NAME}:${IMAGE_TAG}" "$ROOT_DIR"

echo "Tagging and pushing ${IMAGE_URI}..."
docker tag "${REPO_NAME}:${IMAGE_TAG}" "${IMAGE_URI}"
docker push "${IMAGE_URI}"

echo "Image pushed: ${IMAGE_URI}"
