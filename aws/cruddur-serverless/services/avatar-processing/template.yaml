AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31

Description: |
  Image processing and avatar events
  - Optional assets S3 bucket
  - Thumbnail generator
  - SNS events
  - Database consumer

Globals:
  Function:
    Runtime: python3.13
    Timeout: 30
    MemorySize: 512

Parameters:
  AssetsBucketName:
    Type: String
    Default: assets.cruddur.jawid.me

  CreateAssetsBucket:
    Type: String
    AllowedValues: ['true', 'false']
    Default: 'false'

  CorsAllowedOrigins:
    Type: String
    Default: "https://cruddur.jawid.me,http://localhost:3000,https://localhost:3000"

  DatabaseUrl:
    Type: String
    Description: PostgreSQL connection string

  LogRetentionInDays:
    Type: Number
    Default: 30

  NetworkingStack:
    Type: String
    Description: Networking stack name for VPC and subnets
    Default: CrdNet

  DatabaseStack:
    Type: String
    Description: Database stack name for RDS security group
    Default: CrdDb

Conditions:
  ShouldCreateBucket: !Equals [!Ref CreateAssetsBucket, 'true']

Resources:
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub "${AWS::StackName}LambdaSG"
      GroupDescription: Security Group for Lambda functions
      VpcId:
        Fn::ImportValue:
          !Sub "${NetworkingStack}VpcId"
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          DestinationSecurityGroupId:
            Fn::ImportValue:
              !Sub "${DatabaseStack}DBSecurityGroupId"
          Description: Lambda to RDS PostgreSQL
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS outbound for AWS services

  # Allow Lambda access to RDS
  RDSLambdaIngressRule:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId:
        Fn::ImportValue:
          !Sub "${DatabaseStack}DBSecurityGroupId"
      IpProtocol: tcp
      FromPort: 5432
      ToPort: 5432
      SourceSecurityGroupId: !Ref LambdaSecurityGroup
      Description: Lambda to RDS PostgreSQL

  AssetsBucket:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-s3-bucket.html
    Type: AWS::S3::Bucket
    Condition: ShouldCreateBucket
    DeletionPolicy: Retain
    Properties:
      BucketName: !Ref AssetsBucketName
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders: ['*']
            AllowedMethods: [GET, PUT, HEAD]
            AllowedOrigins: !Split [",", !Ref CorsAllowedOrigins]
            MaxAge: 3000

  AvatarEventsTopic:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-sns-topic.html
    Type: AWS::SNS::Topic
    Properties:
      TopicName: cruddur-avatar-events

  ThumbnailLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/lambda/image-to-thumbnail
      RetentionInDays: !Ref LogRetentionInDays

  ThumbnailLambda:
    Type: AWS::Serverless::Function
    DependsOn:
      - ThumbnailLogGroup
    Properties:
      FunctionName: image-to-thumbnail
      CodeUri: functions/image_to_thumbnail/
      Handler: app.lambda_handler
      Environment:
        Variables:
          THUMBING_BUCKET_NAME: !Ref AssetsBucketName
          THUMBING_S3_FOLDER_INPUT: avatar/original/
          THUMBING_S3_FOLDER_OUTPUT: avatar/processed/
          THUMBING_TOPIC_ARN: !Ref AvatarEventsTopic
          AVATAR_DB_CONSUMER_ARN: !GetAtt AvatarDbConsumer.Arn
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref AssetsBucketName
        - S3WritePolicy:
            BucketName: !Ref AssetsBucketName
        - SNSPublishMessagePolicy:
            TopicName: cruddur-avatar-events
        - Statement:
            Effect: Allow
            Action: lambda:InvokeFunction
            Resource: !GetAtt AvatarDbConsumer.Arn

  AvatarDbConsumerLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/lambda/avatar-db-consumer
      RetentionInDays: !Ref LogRetentionInDays

  AvatarDbConsumer:
    Type: AWS::Serverless::Function
    DependsOn:
      - AvatarDbConsumerLogGroup
    Properties:
      FunctionName: avatar-db-consumer
      CodeUri: functions/avatar_db_consumer/
      Handler: app.lambda_handler
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          Fn::Split:
            - ","
            - Fn::ImportValue:
                !Sub "${NetworkingStack}PrivateSubnetIds"
      Environment:
        Variables:
          ASSETS_BASE_URL: !Sub "https://${AssetsBucketName}"
          DATABASE_URL: !Ref DatabaseUrl
      Policies:
        - AWSLambdaVPCAccessExecutionRole
        - AWSLambdaBasicExecutionRole
      Events:
        AvatarEvents:
          Type: SNS
          Properties:
            Topic: !Ref AvatarEventsTopic

Outputs:
  AssetsBucketName:
    Value: !Ref AssetsBucketName

  AvatarEventsTopicArn:
    Value: !Ref AvatarEventsTopic
    Export:
      Name: CruddurAvatarEventsTopicArn
