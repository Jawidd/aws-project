AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31

Description: |
  Image processing and avatar events
  - Optional assets S3 bucket
  - Thumbnail generator
  - SNS events
  - Database consumer

Globals:
  Function:
    Runtime: python3.13
    Timeout: 30
    MemorySize: 512

Parameters:
  AssetsBucketName:
    Type: String
    Default: assets.cruddur.jawid.me

  CreateAssetsBucket:
    Type: String
    AllowedValues: ['true', 'false']
    Default: 'false'

  CorsAllowedOrigins:
    Type: String
    Default: "https://cruddur.jawid.me,http://localhost:3000,https://localhost:3000"

  DatabaseUrl:
    Type: String
    Description: PostgreSQL connection string

  LogRetentionInDays:
    Type: Number
    Default: 30

Conditions:
  ShouldCreateBucket: !Equals [!Ref CreateAssetsBucket, 'true']

Resources:
  AssetsBucket:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-s3-bucket.html
    Type: AWS::S3::Bucket
    Condition: ShouldCreateBucket
    DeletionPolicy: Retain
    Properties:
      BucketName: !Ref AssetsBucketName
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders: ['*']
            AllowedMethods: [GET, PUT, HEAD]
            AllowedOrigins: !Split [",", !Ref CorsAllowedOrigins]
            MaxAge: 3000

  AvatarEventsTopic:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-sns-topic.html
    Type: AWS::SNS::Topic
    Properties:
      TopicName: cruddur-avatar-events

  ThumbnailLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/lambda/image-to-thumbnail
      RetentionInDays: !Ref LogRetentionInDays

  ThumbnailLambda:
    Type: AWS::Serverless::Function
    DependsOn:
      - ThumbnailLogGroup
    Properties:
      FunctionName: image-to-thumbnail
      CodeUri: functions/image_to_thumbnail/
      Handler: app.lambda_handler
      Environment:
        Variables:
          THUMBING_BUCKET_NAME: !Ref AssetsBucketName
          THUMBING_S3_FOLDER_INPUT: avatar/original/
          THUMBING_S3_FOLDER_OUTPUT: avatar/processed/
          THUMBING_TOPIC_ARN: !Ref AvatarEventsTopic
          AVATAR_DB_CONSUMER_ARN: !GetAtt AvatarDbConsumer.Arn
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref AssetsBucketName
        - S3WritePolicy:
            BucketName: !Ref AssetsBucketName
        - SNSPublishMessagePolicy:
            TopicName: cruddur-avatar-events
        - Statement:
            Effect: Allow
            Action: lambda:InvokeFunction
            Resource: !GetAtt AvatarDbConsumer.Arn

  AvatarDbConsumerLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/lambda/avatar-db-consumer
      RetentionInDays: !Ref LogRetentionInDays

  AvatarDbConsumer:
    Type: AWS::Serverless::Function
    DependsOn:
      - AvatarDbConsumerLogGroup
    Properties:
      FunctionName: avatar-db-consumer
      CodeUri: functions/avatar_db_consumer/
      Handler: app.lambda_handler
      Environment:
        Variables:
          ASSETS_BASE_URL: !Sub "https://${AssetsBucketName}"
          DATABASE_URL: !Ref DatabaseUrl
      Policies:
        - AWSLambdaBasicExecutionRole
      Events:
        AvatarEvents:
          Type: SNS
          Properties:
            Topic: !Ref AvatarEventsTopic

Outputs:
  AssetsBucketName:
    Value: !Ref AssetsBucketName

  AvatarEventsTopicArn:
    Value: !Ref AvatarEventsTopic
    Export:
      Name: CruddurAvatarEventsTopicArn
