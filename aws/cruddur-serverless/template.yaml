AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31

Description: |
  Cruddur Serverless Application - Merged Template
  - DynamoDB tables (Messages, Conversations, WebSocket Connections)
  - WebSocket API Gateway with connect/disconnect handlers
  - Message stream processing Lambda
  - Cognito post-confirmation Lambda
  - Avatar processing pipeline (S3, SNS, Lambda)
  - Avatar presign API (HTTP API with Cognito auth)
  - Comprehensive IAM roles and security groups
  - CloudWatch log retention and monitoring

Parameters:
  # Database Configuration ------
  DatabaseUrl:
    Type: String
    Default: arn:aws:ssm:eu-west-2:225442939245:parameter/cruddur/CONNECTION_URL
    Description: PostgreSQL connection string for RDS database

  # S3 Assets Configuration ------
  AssetsBucketName:
    Type: String
    Default: assets.cruddur.jawid.me
    Description: S3 bucket name for avatar and asset storage

  AvatarUploadPrefix:
    Type: String
    Default: avatar/original/
    Description: S3 prefix for original avatar uploads

  CoverPhotoPrefix:
    Type: String
    Default: cover-photos/
    Description: S3 prefix for cover photo uploads



  # Frontend Configuration ------
  FrontendOrigin:
    Type: String
    Default: https://cruddur.jawid.me
    Description: Frontend origin URL for CORS configuration

  CorsAllowedOrigins:
    Type: String
    Default: "https://cruddur.jawid.me"
    Description: Comma-delimited list of allowed CORS origins

  # Cognito Configuration ------
  CognitoUserPoolId:
    Type: String
    Description: Cognito User Pool ID for authentication

  CognitoUserPoolClientId:
    Type: String
    Description: Cognito User Pool Client ID for authentication

  # Infrastructure Stack References ------
  NetworkingStack:
    Type: String
    Description: Networking stack name for VPC and subnets
    Default: CrdNet

  DatabaseStack:
    Type: String
    Description: Database stack name for RDS security group
    Default: CrdDb

  FrontendStack:
    Type: String
    Description: Frontend stack name for assets distribution reference
    Default: CrdSrvFrontend

  # DynamoDB Table Names ------
  MessagesTableName:
    Type: String
    Default: cruddur-messages
    Description: DynamoDB table name for messages

  ConversationsTableName:
    Type: String
    Default: cruddur-conversations
    Description: DynamoDB table name for conversations

  ConnectionsTableName:
    Type: String
    Default: cruddur-websocket-connections
    Description: DynamoDB table name for WebSocket connections

  # WebSocket Configuration ------
  WebSocketApiName:
    Type: String
    Default: cruddur-websocket
    Description: WebSocket API Gateway name

  StageName:
    Type: String
    Default: prod
    Description: API Gateway stage name

  # Lambda Configuration ------
  Runtime:
    Type: String
    Default: python3.12
    Description: Lambda runtime version

  LogRetentionInDays:
    Type: Number
    Default: 30
    Description: CloudWatch log retention period in days

  # Safety Configuration ------
  DeletionProtection:
    Type: String
    AllowedValues:
      - true
      - false
    Default: true
    Description: Enable deletion protection for DynamoDB tables

Conditions:
  EnableDeletionProtection: !Equals [!Ref DeletionProtection, true]


Globals:
  Function:
    Runtime: !Ref Runtime
    Timeout: 30
    Tracing: Active

Resources:

  # DYNAMODB TABLES
 
  MessagesTable:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-dynamodb-table.html
    Type: AWS::DynamoDB::Table
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-attribute-deletionpolicy.html
    DeletionPolicy: Retain
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-attribute-updatereplacepolicy.html
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Ref MessagesTableName
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true

  ConversationsTable:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-dynamodb-table.html
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Ref ConversationsTableName
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
        - AttributeName: last_message_timestamp
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      GlobalSecondaryIndexes:
        - IndexName: LastMessageIndex
          KeySchema:
            - AttributeName: pk
              KeyType: HASH
            - AttributeName: last_message_timestamp
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true

  ConnectionsTable:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-dynamodb-table.html
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Ref ConnectionsTableName
      AttributeDefinitions:
        - AttributeName: connectionId
          AttributeType: S
      KeySchema:
        - AttributeName: connectionId
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  # ======================================================================
  # WEBSOCKET API GATEWAY
  # ======================================================================

  WebSocketApi:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigatewayv2-api.html
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: !Ref WebSocketApiName
      ProtocolType: WEBSOCKET
      RouteSelectionExpression: "$request.body.action"

  WebSocketStage:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigatewayv2-stage.html
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId: !Ref WebSocketApi
      StageName: !Ref StageName
      AutoDeploy: true

  # ======================================================================
  # S3 ASSETS BUCKET
  # ======================================================================

  AssetsBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Properties:
      BucketName: !Ref AssetsBucketName
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders: ['*']
            AllowedMethods: [GET, PUT, HEAD]
            AllowedOrigins: !Split [",", !Ref CorsAllowedOrigins]
            MaxAge: 3000

  AssetsBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref AssetsBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowCloudFrontReadOnly
            Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetObject
            Resource: !Sub "arn:aws:s3:::${AssetsBucketName}/*"
            Condition:
              StringEquals:
                AWS:SourceArn: 
                  Fn::Sub:
                    - "arn:aws:cloudfront::${AWS::AccountId}:distribution/${DistributionId}"
                    - DistributionId:
                        Fn::ImportValue: !Sub "${FrontendStack}AssetsDistributionId"

  # ======================================================================
  # SNS TOPICS
  # ======================================================================

  AvatarEventsTopic:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-sns-topic.html
    Type: AWS::SNS::Topic
    Properties:
      TopicName: cruddur-avatar-events

  # ======================================================================
  # HTTP API GATEWAY (AVATAR PRESIGN)
  # ======================================================================

  AvatarUploadApi:
    # https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-resource-httpapi.html
    Type: AWS::Serverless::HttpApi
    Properties:
      CorsConfiguration:
        AllowHeaders:
          - Authorization
          - Content-Type
        AllowMethods:
          - OPTIONS
          - POST
        AllowOrigins:
          - !Ref FrontendOrigin
          - http://localhost:3000
          - https://localhost:3000
      Auth:
        DefaultAuthorizer: CognitoAuthorizer
        Authorizers:
          CognitoAuthorizer:
            JwtConfiguration:
              audience:
                - !Ref CognitoUserPoolClientId
              issuer: !Sub "https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPoolId}"
            IdentitySource: "$request.header.Authorization"

  # ======================================================================
  # SECURITY GROUPS
  # ======================================================================

  PostConfirmationSecurityGroup:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-securitygroup.html
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub "${AWS::StackName}PostConfirmationSG"
      GroupDescription: Security Group for Post Confirmation Lambda
      VpcId:
        Fn::ImportValue:
          !Sub "${NetworkingStack}VpcId"
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS for AWS services
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          DestinationSecurityGroupId:
            Fn::ImportValue: !Sub "${DatabaseStack}DBSecurityGroupId"
          Description: Post Confirmation Lambda to RDS

  AvatarDbConsumerSecurityGroup:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-securitygroup.html
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub "${AWS::StackName}AvatarDbConsumerSG"
      GroupDescription: Security Group for Avatar DB Consumer Lambda
      VpcId:
        Fn::ImportValue:
          !Sub "${NetworkingStack}VpcId"
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS for AWS services
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          DestinationSecurityGroupId:
            Fn::ImportValue: !Sub "${DatabaseStack}DBSecurityGroupId"
          Description: Avatar DB Consumer Lambda to RDS




  # ======================================================================
  # CLOUDWATCH LOG GROUPS
  # ======================================================================

  MessageStreamLogGroup:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-logs-loggroup.html
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/lambda/message-stream
      RetentionInDays: !Ref LogRetentionInDays

  WebSocketConnectLogGroup:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-logs-loggroup.html
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/lambda/websocket-connect
      RetentionInDays: !Ref LogRetentionInDays

  WebSocketDisconnectLogGroup:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-logs-loggroup.html
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/lambda/websocket-disconnect
      RetentionInDays: !Ref LogRetentionInDays

  PostConfirmationLogGroup:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-logs-loggroup.html
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/lambda/post-email-confirm
      RetentionInDays: !Ref LogRetentionInDays

  ThumbnailLogGroup:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-logs-loggroup.html
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/lambda/image-to-thumbnail
      RetentionInDays: !Ref LogRetentionInDays

  AvatarDbConsumerLogGroup:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-logs-loggroup.html
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/lambda/avatar-db-consumer
      RetentionInDays: !Ref LogRetentionInDays

  AvatarPresignLogGroup:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-logs-loggroup.html
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/lambda/avatar-presign
      RetentionInDays: !Ref LogRetentionInDays

  # ======================================================================
  # IAM EXECUTION ROLES
  # ======================================================================

  MessageStreamExecutionRole:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-iam-role.html
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AWS::StackName}MessageStreamRole"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: message-stream-logs
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: LogsWrite
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/message-stream:*"
        - PolicyName: message-stream-dynamodb
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: TablesCrud
                Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource:
                  - !GetAtt MessagesTable.Arn
                  - !GetAtt ConversationsTable.Arn
                  - !GetAtt ConnectionsTable.Arn
              - Sid: StreamRead
                Effect: Allow
                Action:
                  - dynamodb:DescribeStream
                  - dynamodb:GetRecords
                  - dynamodb:GetShardIterator
                  - dynamodb:ListStreams
                Resource:
                  - !GetAtt MessagesTable.StreamArn
        - PolicyName: message-stream-manage-connections
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: ManageConnections
                Effect: Allow
                Action:
                  - execute-api:ManageConnections
                Resource:
                  - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/${StageName}/POST/@connections/*"

  WebSocketConnectExecutionRole:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-iam-role.html
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AWS::StackName}WebSocketConnectRole"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: websocket-connect-logs
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: LogsWrite
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/websocket-connect:*"
        - PolicyName: websocket-connect-dynamodb
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: ConnectionsCrud
                Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:GetItem
                  - dynamodb:Query
                Resource:
                  - !GetAtt ConnectionsTable.Arn

  WebSocketDisconnectExecutionRole:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-iam-role.html
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AWS::StackName}WebSocketDisconnectRole"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: websocket-disconnect-logs
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: LogsWrite
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/websocket-disconnect:*"
        - PolicyName: websocket-disconnect-dynamodb
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: ConnectionsCrud
                Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:GetItem
                  - dynamodb:Query
                Resource:
                  - !GetAtt ConnectionsTable.Arn

  # ======================================================================
  # LAMBDA FUNCTIONS
  # ======================================================================

  MessageStreamFunction:
    # https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-resource-function.html
    Type: AWS::Serverless::Function
    DependsOn:
      - MessageStreamLogGroup
    Properties:
      FunctionName: message-stream
      CodeUri: functions/message_stream/
      Handler: app.lambda_handler
      Description: Broadcasts new conversation messages to active WebSocket connections
      Role: !GetAtt MessageStreamExecutionRole.Arn
      Timeout: 30
      Environment:
        Variables:
          DYNAMODB_MESSAGES_TABLE: !Ref MessagesTableName
          DYNAMODB_CONVERSATIONS_TABLE: !Ref ConversationsTableName
          CONNECTIONS_TABLE: !Ref ConnectionsTableName
          WEBSOCKET_API_ENDPOINT: !Sub "https://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${StageName}"
      Events:
        MessagesStreamEvent:
          Type: DynamoDB
          Properties:
            Stream: !GetAtt MessagesTable.StreamArn
            StartingPosition: LATEST
            BatchSize: 10

  WebSocketConnectFunction:
    # https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-resource-function.html
    Type: AWS::Serverless::Function
    DependsOn:
      - WebSocketConnectLogGroup
    Properties:
      FunctionName: websocket-connect
      CodeUri: functions/websocket_connect/
      Handler: app.lambda_handler
      Description: Registers a WebSocket connection record with a short TTL
      Role: !GetAtt WebSocketConnectExecutionRole.Arn
      Environment:
        Variables:
          CONNECTIONS_TABLE: !Ref ConnectionsTableName

  WebSocketDisconnectFunction:
    # https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-resource-function.html
    Type: AWS::Serverless::Function
    DependsOn:
      - WebSocketDisconnectLogGroup
    Properties:
      FunctionName: websocket-disconnect
      CodeUri: functions/websocket_disconnect/
      Handler: app.lambda_handler
      Description: Deletes the WebSocket connection record when clients disconnect
      Role: !GetAtt WebSocketDisconnectExecutionRole.Arn
      Environment:
        Variables:
          CONNECTIONS_TABLE: !Ref ConnectionsTableName

  PostConfirmationFunction:
    # https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-resource-function.html
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: python3.12
      BuildProperties:
        use_container: true
    DependsOn:
      - PostConfirmationLogGroup
    Properties:
      FunctionName: post-email-confirm
      CodeUri: functions/post_email_confirm/
      Handler: app.lambda_handler
      Description: Creates user record after Cognito email confirmation
      VpcConfig:
        SecurityGroupIds:
          - !Ref PostConfirmationSecurityGroup
        SubnetIds: !Split 
          - ","
          - Fn::ImportValue: !Sub "${NetworkingStack}PrivateSubnetIds"
      Environment:
        Variables:
          DATABASE_URL: !Ref DatabaseUrl
      Policies:
        - SSMParameterReadPolicy:
            ParameterName: cruddur/CONNECTION_URL
        - VPCAccessPolicy: {}

  ThumbnailLambda:
    # https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-resource-function.html
    Type: AWS::Serverless::Function
    DependsOn:
      - ThumbnailLogGroup
    Properties:
      FunctionName: image-to-thumbnail
      CodeUri: functions/image_to_thumbnail/
      Handler: app.lambda_handler
      Description: Generates avatar thumbnails, cleans old files, and emits avatar events
      MemorySize: 512
      Environment:
        Variables:
          THUMBING_BUCKET_NAME: !Ref AssetsBucketName
          THUMBING_S3_FOLDER_INPUT: avatar/original/
          THUMBING_S3_FOLDER_OUTPUT: avatar/processed/
          THUMBING_TOPIC_ARN: !Ref AvatarEventsTopic
          AVATAR_DB_CONSUMER_ARN: !GetAtt AvatarDbConsumer.Arn
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref AssetsBucketName
        - S3WritePolicy:
            BucketName: !Ref AssetsBucketName
        - SNSPublishMessagePolicy:
            TopicName: cruddur-avatar-events
        - Statement:
            Effect: Allow
            Action: lambda:InvokeFunction
            Resource: !GetAtt AvatarDbConsumer.Arn
      Events:
        AvatarUpload:
          Type: S3
          Properties:
            Bucket: !Ref AssetsBucket
            Events: s3:ObjectCreated:*
            Filter:
              S3Key:
                Rules:
                  - Name: prefix
                    Value: avatar/original/

  AvatarDbConsumer:
    # https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-resource-function.html
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: python3.12
      BuildProperties:
        use_container: true
    DependsOn:
      - AvatarDbConsumerLogGroup
    Properties:
      FunctionName: avatar-db-consumer
      CodeUri: functions/avatar_db_consumer/
      Handler: app.lambda_handler
      Description: Updates user avatar URLs in the database from avatar events
      MemorySize: 512
      VpcConfig:
        SecurityGroupIds:
          - !Ref AvatarDbConsumerSecurityGroup
        SubnetIds: !Split 
          - ","
          - Fn::ImportValue: !Sub "${NetworkingStack}PrivateSubnetIds"



      Environment:
        Variables:
          ASSETS_BASE_URL: !Sub "https://${AssetsBucketName}"
          DATABASE_URL: !Ref DatabaseUrl
      Policies:
        - AWSLambdaBasicExecutionRole
        - SSMParameterReadPolicy:
            ParameterName: cruddur/CONNECTION_URL
        - VPCAccessPolicy: {}
      Events:
        AvatarEvents:
          Type: SNS
          Properties:
            Topic: !Ref AvatarEventsTopic
        CoverPhotoEvents:
          Type: S3
          Properties:
            Bucket: !Ref AssetsBucket
            Events: s3:ObjectCreated:*
            Filter:
              S3Key:
                Rules:
                  - Name: prefix
                    Value: cover-photos/

  AvatarPresignFunction:
    # https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-resource-function.html
    Type: AWS::Serverless::Function
    DependsOn:
      - AvatarPresignLogGroup
    Properties:
      FunctionName: avatar-presign
      CodeUri: functions/avatar_presign/
      Handler: app.lambda_handler
      Description: Issues presigned S3 upload URLs for authenticated avatar uploads
      Timeout: 20
      MemorySize: 128
      Environment:
        Variables:
          AVATAR_UPLOAD_BUCKET: !Ref AssetsBucketName
          AVATAR_UPLOAD_PREFIX: !Ref AvatarUploadPrefix
          COVER_PHOTO_PREFIX: !Ref CoverPhotoPrefix
          PRESIGN_URL_TTL_SECONDS: '300'
      Policies:
        - S3WritePolicy:
            BucketName: !Ref AssetsBucketName
      Events:
        Presign:
          Type: HttpApi
          Properties:
            ApiId: !Ref AvatarUploadApi
            Path: /avatars/presign
            Method: POST

  # ======================================================================
  # WEBSOCKET INTEGRATIONS
  # ======================================================================

  ConnectIntegration:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigatewayv2-integration.html
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketConnectFunction.Arn}/invocations"

  DisconnectIntegration:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigatewayv2-integration.html
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketDisconnectFunction.Arn}/invocations"

  # ======================================================================
  # WEBSOCKET ROUTES
  # ======================================================================

  ConnectRoute:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigatewayv2-route.html
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: $connect
      AuthorizationType: NONE
      Target: !Sub "integrations/${ConnectIntegration}"

  DisconnectRoute:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigatewayv2-route.html
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: $disconnect
      AuthorizationType: NONE
      Target: !Sub "integrations/${DisconnectIntegration}"

  # ======================================================================
  # LAMBDA PERMISSIONS
  # ======================================================================

  ConnectPermission:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-permission.html
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WebSocketConnectFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*"

  DisconnectPermission:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-permission.html
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WebSocketDisconnectFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*"

Outputs:
  # DynamoDB Tables ------
  MessagesTableName:
    Description: "Messages DynamoDB Table Name"
    Value: !Ref MessagesTableName
    Export:
      Name: CruddurMessagesTableNameV2

  ConversationsTableName:
    Description: "Conversations DynamoDB Table Name"
    Value: !Ref ConversationsTableName
    Export:
      Name: CruddurConversationsTableNameV2

  ConnectionsTableName:
    Description: "WebSocket Connections DynamoDB Table Name"
    Value: !Ref ConnectionsTableName

  # Lambda Functions ------
  PostConfirmationFunctionArn:
    Description: "Post Confirmation Lambda Function ARN"
    Value: !GetAtt PostConfirmationFunction.Arn
    Export:
      Name: CruddurPostConfirmationLambdaArnV2

  MessageStreamFunctionArn:
    Description: "Message Stream Lambda Function ARN"
    Value: !GetAtt MessageStreamFunction.Arn
    Export:
      Name: CruddurMessageStreamLambdaArnV2

  # API Endpoints ------
  WebSocketApiEndpoint:
    Description: "WebSocket API Gateway endpoint"
    Value: !Sub "wss://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${StageName}"
    Export:
      Name: CruddurWebSocketEndpoint

  AvatarUploadApiUrl:
    Description: "HTTP API endpoint for presigned avatar uploads"
    Value: !Sub "https://${AvatarUploadApi}.execute-api.${AWS::Region}.amazonaws.com"
    Export:
      Name: CruddurAvatarUploadApiUrl

  # S3 and SNS ------
  AssetsBucketName:
    Description: "Assets S3 bucket name"
    Value: !Ref AssetsBucketName

  AvatarEventsTopicArn:
    Description: "Avatar events SNS topic ARN"
    Value: !Ref AvatarEventsTopic
    Export:
      Name: CruddurAvatarEventsTopicArn
