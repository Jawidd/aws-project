#!/usr/bin/env bash

# Load environment variables
source $(dirname "$0")/../.env

# Output SQL file
OUTPUT_FILE="$(dirname "$0")/recived_seed_from_rds_psql.sql"

# Choose connection based on environment
if [ "$ENV_TYPE" = "prod" ]; then
    CONNECTION="$AWS_RDS_PSQL_CONNECTION"
    echo "== Fetching users from PROD database =="
else
    CONNECTION="$CONNECTION_URL"
    echo "== Fetching users from LOCAL database =="
fi

# Get all column names from the 'users' table dynamically
COLUMNS=$(psql "$CONNECTION" -Atc "SELECT column_name FROM information_schema.columns WHERE table_name='users' ORDER BY ordinal_position;")
COLUMNS_LIST=$(echo "$COLUMNS" | paste -sd"," -)

# Header for SQL file
echo "-- ============================\n-- Users\n-- ============================\n" > "$OUTPUT_FILE"

# Pull all data dynamically
psql "$CONNECTION" -Atc "SELECT * FROM public.users ORDER BY created_at;" | while IFS='|' read -r $(echo $COLUMNS | tr '\n' ' '); do
    # Prepare values
    VALUES=""
    for col in $COLUMNS; do
        val=${!col}
        if [ -z "$val" ] || [ "$val" = "NULL" ]; then
            VALUES+="NULL,"
        else
            # Escape single quotes
            val_escaped=$(echo "$val" | sed "s/'/''/g")
            VALUES+="'$val_escaped',"
        fi
    done
    # Remove trailing comma
    VALUES=${VALUES%,}

    # Write INSERT statement
    echo "INSERT INTO public.users ($COLUMNS_LIST) VALUES ($VALUES);" >> "$OUTPUT_FILE"
done

echo "SQL insert statements saved to $OUTPUT_FILE"
